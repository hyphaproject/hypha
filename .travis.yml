language:
 - cpp

os:
 - linux
dist: trusty
sudo: required
compiler:
     - gcc
     - clang

env:
 global:
  # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
  #   via the "travis encrypt" command using the project repo's public key
  - secure: "PUY/SRJDZlnuJ6OUt+HpBpvRvUmpNPxqQeQZIUPKgSbSPQmLu7Llnz4yf7Plgkjcj5mKFhtTfiiQWV3eJulBliaWCxsgr6uzlaWd8gQ48a5EFYaoyI1oag8Dn9mlx7x++6a3F/RxS1mKxfaTbn3+Pfc+jYjzmpqXgTGy85H7b8xyPaCqBE34wR1gaQfFcLP/BhBm1q7pD20BgTKQ3XoyXq3Kod+PpSs829vuFnqhCpNZYt1GAx5q7p665SVVJcfVESwJK7ww3TayXvJuJGdwGzHisaQobqwOn//MJfMWwN9qZ3/NWeDHA6K4MW5Fa4BgD5zI17ZBoVKpYXdDBsBf/pKPlwQ2mnylzypO6GS/GXb3lS9HRgtwQtLuj0qD+p849TQtfA38pL+hLTSxg71a5QfSzdjTcAUALLhPjak8Jn1Cd/aJGdPEuCMlgCnoz7CInp/caVvdU5d/bSxq9uf31wZrCcVdLrGTkDDXMqNL7koWt9o3c/5Zx7gT4m/EW6mUyQmhxZ8qovlCLQCrWGfCWKWnMh9mtJ4d0WA1XZhautrNKlZwJdpm5ISc7KcoAvUawl0A1ITCizLwOf+vWm2Y26WYtYeBrJzqUM2zWWS61amjIQbxU44q8tTVKk8IkDr6Z6GIshF9SQ23Ec82DMc4yY64yu2pSMe09iO1mneRWCs="


addons:
 coverity_scan:
    project:
      name: "hyphaproject/hypha"
      description: "Build submitted via Travis CI"
    notification_email: chriamue@gmail.com
    build_command_prepend: "cmake -DOPTION_BUILD_TESTS=1 -DCMAKE_BUILD_TYPE=Debug ."
    build_command:   "cmake --build ."
    branch_pattern: coverity_scan

 apt:
  sources:
   - ubuntu-toolchain-r-test
  
  packages:
   - gcc-5
   - g++-5
   - build-essential
   - cmake
   - git
   - rpm
   - libgtk2.0-dev
   - pkg-config
   - python-dev
   - python-numpy
   - lcov
   - libboost-all-dev
   - libpoco-dev
   - libmysqlclient-dev
   - texlive-fonts-recommended
   - texlive-latex-extra
   - texlive-fonts-extra
   - dvipng
   - texlive-latex-recommended
   - texlive-full

before_install:
 - echo -n | openssl s_client -connect scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-

install:
 - sudo pip install cpp-coveralls
 - sudo apt-get update -qq && sudo apt-get install -qq libpoco-dev libboost-all-dev

before_script:
 - sudo unlink /usr/bin/gcc && sudo ln -s /usr/bin/gcc-5 /usr/bin/gcc
 - sudo unlink /usr/bin/g++ && sudo ln -s /usr/bin/g++-5 /usr/bin/g++
 - gcc -v
 - g++ -v
 - sudo ldconfig

 - wget http://www.cmake.org/files/v3.6/cmake-3.6.0.tar.gz
 - tar xf cmake-3.6.0.tar.gz
 - cd cmake-3.6.0
 - ./configure
 - make
 - sudo make install
 - cd ..

 - git clone https://github.com/pocoproject/poco
 - sed -i 's#mysqlclient_r#mysqlclient mysqlclient_r#g' poco/cmake/FindMySQL.cmake
 - cd poco
 - mkdir -p build
 - cd build
 - cmake -DCMAKE_BUILD_TYPE=Release .. && make -j3 && sudo make install && sudo ldconfig
 - cd ../..

 - mkdir build
 - cd build
 - cmake -DCMAKE_CXX_COMPILER=$CXX -DOPTION_BUILD_TESTS=1 -DOPTION_BUILD_DOCS=1 -DCMAKE_BUILD_TYPE=Coverage ..
script:
 - make -j4
 - make pack

after_success:
 - make hypha_coverage
 - cd ..
 - coveralls --root "." -E ".*/cmake-3.6.0/.*" -E ".*/poco/.*" -E ".*/build/gtest/.*" -E ".*CMakeFiles.*" -E ".*tests/.*.cpp.*"

deploy:
  provider: releases
  api_key: "$GH_TOKEN"
  file_glob: true
  file:
   - $TRAVIS_BUILD_DIR/build/docs/manual/*.pdf
   - $TRAVIS_BUILD_DIR/build/*.deb
   - $TRAVIS_BUILD_DIR/build/*.rpm
  skip_cleanup: true
  on:
    tags: true

notifications:
